## Problem B: The gamma distribution


### 1. Rejection sampling

## (a) Acceptance probability

The acceptance probability is the inverse of the constant $c$ used in the rejection-sampling algorithm. The constant $c$ is chosen to be the smallest value that satisfies $c \leq \frac{f(x)}{g(x)}$. 

With $f(x) = \frac{1}{\Gamma(\alpha)}x^{\alpha -1}e^{-x}$ and $g(x)$ as specified in A.2, we must choose $c$ such that

$$
c \geq \frac{f(x)}{g(x)} = \begin{cases}\frac{1}{\Gamma(\alpha)}\frac{\alpha + e}{e\alpha}\frac{1}{e^x},\quad 0 < x < 1 \\ 
\frac{1}{\Gamma(\alpha)}\frac{\alpha + e}{e\alpha}x^{\alpha - 1},\quad x \geq 1\end{cases}
$$
This functions attains it's maximum at $x=1$, and $\frac{f(x)}{g(x)}\mid_{x=1} = \frac{1}{\Gamma(\alpha)}\frac{\alpha + e}{e\alpha}$ and choosing $c \frac{f(x)}{g(x)}\mid_{x=1}$ satisfies the criterion above. This leads to the acceptance probability $\Gamma(\alpha)\frac{e\alpha}{e + \alpha}$.

## (b) Rejection-sampling implementation


```{r}
n <- 100000
rate <- 0.4

rf <- function(n, rate){
  dg_fixed <- partial(dg, rate=rate)
  df <- as_mapper(~1/gamma(rate)*.x^(rate - 1)*exp(-.x))

  c <- (rate + exp(1))/(rate*exp(1))/gamma(rate)
  alpha_mapper <- as_mapper(~1/c*df(.x)/dg_fixed(.x))

  xs <- rg(n, rate=rate) %>% use_series(value)
  alpha <- xs %>% map_dbl(alpha_mapper)

  accepted_xs <- xs %>% keep(runif(n) < alpha) %>% enframe
}

fixed_size_rf <- function(n, rate){
  overall_acceptance_probability <- (rate + exp(1))/(rate*exp(1))/gamma(rate)
  expected_required_n <- n*overall_acceptance_probability
  df <- rf(expected_required_n, rate)
  while (TRUE){
    if (nrow(df) < n){
      df <- bind_rows(df, rf((n - nrow(df))*overall_acceptance_probability, rate))
    }
    else if (nrow(df > n)){
      return(df[1:n,])
    }
    else{
      return(df)
    }
  }
}

random_f <- fixed_size_rf(n, rate)

df <- as_mapper(~1/gamma(rate)*.x^(rate - 1)*exp(-.x))
dg_fixed <- partial(dg, rate=rate)
c <- (rate + exp(1))/(rate*exp(1))/gamma(rate)
dg_scaled <- as_mapper(~dg_fixed(.x)*c)

ggplot(random_f) +
  geom_histogram(aes(x=value, y=..density..), binwidth=0.05, boundary=0) +
  stat_function(fun=df, color='red', size=1) +
  stat_function(fun=dg_scaled, color='green', size=1, linetype="dashed") +
  ylim(0, 1) +
  xlim(0, NA)

print(paste("Acceptance probability:", 1/c))
```



### 2. Ratio of uniforms method

## (a)

To find the values of $a$ and $b_{+}$ we take the of derivative of $f^{\star}(x)$ and $x^2f^{\star}(x)$and set it equal to zero. This gives us the values for which the two functions are maximized. By evaluating the functions at these points, $x = \sqrt{\alpha - 1}$ and $x = \sqrt{\alpha + 1}$ respectively, one obtains that
$a = \sqrt{\left(\frac{\alpha - 1}{e}\right)^{\alpha - 1}}$ and $b_{+} = \sqrt{\left(\frac{\alpha + 1}{e}\right)^{\alpha + 1}}$. The function $f^{\star}(x)$ is zero for $x \leq 0$, so it's supremum is 0 in this region, giving us $b_{-} = 0$.

```{r}
rate <- 5
a <- sqrt(((rate - 1)/exp(1))^(rate - 1))
b_plus <- sqrt(((rate + 1)/exp(1))^(rate +1))
b_minus <- 0

n <- 10000
x1 <- runif(n)*a
x2 <- runif(n)*b_plus - b_minus

random_samples <- tibble(x1, x2)

random_samples <- random_samples %>%
  mutate(upperBound = ((rate - 1)*log(x2/x1) - x2 + x1)/2) %>%
  mutate(inRegion = log(x1) <= upperBound)

random_samples %>%
  ggplot() +
  geom_point(aes(x=x1, y=x2, colour=inRegion)) +
  coord_flip()

accepted_samples <- random_samples %>% filter(inRegion == TRUE) %>% mutate(y = x2/x1)

accepted_samples %>%
  filter(y < quantile(y, probs = 0.95)) %>%
  ggplot() +
  geom_histogram(aes(x=y, y=..density..), binwidth=0.1) +
  stat_function(aes(x=y), fun = dgamma, args = list(shape = rate, scale = 1))
```






### 3. Arbitrary gamma function

(Answer)
